# Git GUI - Backend Specification

## Backend Data Models (Go)

### Core Structs

```go
// App - main application struct
type App struct {
    ctx context.Context
    repo *GitRepo
}

// GitRepo - represents the git repository state
type GitRepo struct {
    Path          string
    CurrentBranch string
}

// FileStatus - represents a single file's git status
type FileStatus struct {
    Path     string
    Status   StatusType
    Staged   bool
}

// StatusType - enum for file status
type StatusType string

const (
    StatusModified  StatusType = "modified"
    StatusAdded     StatusType = "added"
    StatusDeleted   StatusType = "deleted"
    StatusUntracked StatusType = "untracked"
    StatusRenamed   StatusType = "renamed"
)

// Branch - represents a git branch
type Branch struct {
    Name      string
    IsCurrent bool
    IsRemote  bool
}

// DiffResult - represents the diff output for a file
type DiffResult struct {
    FilePath string
    Diff     string
    Hunks    []DiffHunk
}

// DiffHunk - individual change block (for future hunk selection)
type DiffHunk struct {
    Header    string
    OldStart  int
    OldLines  int
    NewStart  int
    NewLines  int
    Lines     []string
}

// CommitResult - result of commit operation
type CommitResult struct {
    Success   bool
    CommitSHA string
    Message   string
}
```

### App Methods

```go
// Repository operations
func (a *App) InitRepo(path string) error
func (a *App) GetCurrentRepo() (*GitRepo, error)
func (a *App) ValidateRepo(path string) (bool, error)
func (a *App) GetRepoRoot() (string, error)

// File status operations
func (a *App) GetGitStatus() ([]FileStatus, error)
func (a *App) GetGitDiff(filepath string) (*DiffResult, error)

// Branch operations
func (a *App) GetBranches() ([]Branch, error)
func (a *App) GetCurrentBranch() (string, error)
func (a *App) SwitchBranch(name string) error
func (a *App) CreateBranch(name string) error

// Commit operations
func (a *App) CommitFiles(files []string, message string) (*CommitResult, error)
func (a *App) PushChanges() error
func (a *App) CommitAndPush(files []string, message string) (*CommitResult, error)
```

### Implementation Notes

**CommitAndPush Composition:**
```go
func (a *App) CommitAndPush(files []string, message string) (*CommitResult, error) {
    result, err := a.CommitFiles(files, message)
    if err != nil {
        return nil, err
    }
    
    if err := a.PushChanges(); err != nil {
        return nil, err
    }
    
    return result, nil
}
```

**Git Command Execution:**
All git operations should use Go's `os/exec` package to execute git commands as subprocesses. The implementation should:
- Execute commands in the repository directory
- Capture stdout and stderr
- Parse output into structured data
- Return meaningful errors

## Frontend-Backend Contract

### TypeScript Types (Auto-generated by Wails)

```typescript
// These are automatically generated from Go structs

export interface FileStatus {
    Path: string
    Status: StatusType
    Staged: boolean
}

export type StatusType = 
    | "modified" 
    | "added" 
    | "deleted" 
    | "untracked" 
    | "renamed"

export interface Branch {
    Name: string
    IsCurrent: boolean
    IsRemote: boolean
}

export interface DiffResult {
    FilePath: string
    Diff: string
    Hunks: DiffHunk[]
}

export interface DiffHunk {
    Header: string
    OldStart: number
    OldLines: number
    NewStart: number
    NewLines: number
    Lines: string[]
}

export interface CommitResult {
    Success: boolean
    CommitSHA: string
    Message: string
}

export interface GitRepo {
    Path: string
    CurrentBranch: string
}
```

### API Methods (Frontend calls to Backend)

```typescript
// Auto-generated by Wails in wailsjs/go/main/App.js
import * as App from './wailsjs/go/main/App'

// Repository Operations
await App.InitRepo(path: string): Promise<void>
await App.GetCurrentRepo(): Promise<GitRepo>
await App.ValidateRepo(path: string): Promise<boolean>
await App.GetRepoRoot(): Promise<string>

// File Status Operations
await App.GetGitStatus(): Promise<FileStatus[]>
await App.GetGitDiff(filepath: string): Promise<DiffResult>

// Branch Operations
await App.GetBranches(): Promise<Branch[]>
await App.GetCurrentBranch(): Promise<string>
await App.SwitchBranch(name: string): Promise<void>
await App.CreateBranch(name: string): Promise<void>

// Commit Operations
await App.CommitFiles(files: string[], message: string): Promise<CommitResult>
await App.PushChanges(): Promise<void>
await App.CommitAndPush(files: string[], message: string): Promise<CommitResult>
```

### Error Handling

**Backend (Go):**
```go
// Return standard Go errors - Wails handles serialization
func (a *App) GetGitStatus() ([]FileStatus, error) {
    output, err := executeGitCommand("status", "--porcelain")
    if err != nil {
        return nil, fmt.Errorf("failed to get git status: %w", err)
    }
    
    files, err := parseGitStatus(output)
    if err != nil {
        return nil, fmt.Errorf("failed to parse git status: %w", err)
    }
    
    return files, nil
}
```

**Frontend (TypeScript/Svelte):**
```typescript
// Errors are thrown as JavaScript exceptions
try {
    const files = await App.GetGitStatus()
    // Handle success
} catch (error) {
    // Handle error - error.message contains Go error text
    console.error("Failed to get git status:", error)
    showErrorNotification(error.message)
}
```

## Frontend State Management

### Recommended Svelte Stores

```typescript
import { writable, derived } from 'svelte/store'

// Core state
export const repo = writable<GitRepo | null>(null)
export const files = writable<FileStatus[]>([])
export const branches = writable<Branch[]>([])
export const selectedFile = writable<FileStatus | null>(null)
export const currentDiff = writable<string>("")

// UI state
export const commitMessage = writable<string>("")
export const isLoading = writable<boolean>(false)
export const errorMessage = writable<string | null>(null)

// Derived state
export const currentBranch = derived(
    branches,
    $branches => $branches.find(b => b.IsCurrent)?.Name || "unknown"
)

export const stagedFiles = derived(
    files,
    $files => $files.filter(f => f.Staged)
)
```

## Component Structure

### Suggested Components

1. **App.svelte** - Main container, layout orchestration
2. **FileList.svelte** - Left column showing changed files with checkboxes
3. **DiffViewer.svelte** - Right column displaying file diff
4. **BranchSelector.svelte** - Top bar branch dropdown and new branch button
5. **CommitPanel.svelte** - Bottom panel with message input and commit buttons
6. **ErrorNotification.svelte** - Toast/banner for error messages
7. **LoadingSpinner.svelte** - Loading indicator during git operations

### Component Responsibilities

**FileList.svelte:**
- Display list of FileStatus items
- Handle checkbox state for staging
- Handle file selection for diff viewing
- Trigger `GetGitStatus()` on mount

**DiffViewer.svelte:**
- Display diff text with syntax highlighting
- Show additions/deletions with color coding
- Handle empty state when no file selected

**BranchSelector.svelte:**
- Display current branch
- Show dropdown of available branches
- Handle branch switching
- Show modal/dialog for new branch creation

**CommitPanel.svelte:**
- Commit message textarea
- Commit and Commit & Push buttons
- Disable buttons when no files staged or no message
- Clear state after successful commit

## Git Command Mapping

### Core Commands Used

| Operation | Git Command | Notes |
|-----------|-------------|-------|
| Get status | `git status --porcelain` | Machine-readable format |
| Get diff | `git diff <file>` | Unstaged changes |
| Get diff (staged) | `git diff --cached <file>` | Staged changes |
| List branches | `git branch` | Local branches |
| Current branch | `git branch --show-current` | Active branch name |
| Switch branch | `git checkout <branch>` | Change branch |
| Create branch | `git checkout -b <name>` | Create and switch |
| Stage files | `git add <files...>` | Stage for commit |
| Commit | `git commit -m "message"` | Create commit |
| Push | `git push` | Push to remote |

### Parsing Requirements

**git status --porcelain format:**
```
 M file1.txt          # Modified, not staged
M  file2.txt          # Modified, staged
A  file3.txt          # Added, staged
?? file4.txt          # Untracked
```

**git branch format:**
```
* main                # Current branch (asterisk)
  feature/test
  bugfix/issue-123
```

**git diff format:**
Standard unified diff format with hunks starting with `@@`

## Development Principles

### DRY (Don't Repeat Yourself)
